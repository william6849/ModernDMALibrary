name: Codacy Analysis

on: ["push"]

jobs:
  code-analysis:
    name: Code Analysis
    runs-on: DMAHostRunner
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Configure code-analysis Preset
        uses: lukka/run-cmake@2ce8982be71b8e9a3c4d5e432135035afd1e76a7
        with:
          configurePreset: code-analysis
          buildPreset: code-analysis

      - name: Run clang-tidy
        run: |
          cd build
          run-clang-tidy -p ./code-analysis | tee clang-tidy-output.txt
          cd -

      - name: Run Codacy Analysis CLI
        uses: codacy/codacy-analysis-cli-action@97bf5df3c09e75f5bcd72695998f96ebd701846e
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          clang-tidy-output: "build/clang-tidy-output.txt"
          upload: true

      - name: Run Unit Test
        run: |
          cd ./build/code-analysis/bin/
          ./dmatest
          cd -

      - name: Generate coverage info
        run: |
          cd ./build/code-analysis
          lcov --capture --directory . --output-file coverage.info
          lcov --ignore-errors unused --remove coverage.info '/usr/include/*' 'submodules' 'googletest' ".yaml" ".json" -o filtered_coverage.info
          cd -

      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: ./build/code-analysis/filtered_coverage.info
